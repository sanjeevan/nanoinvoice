if(typeof(console)==="undefined"){var console={};console.log=console.error=console.info=console.debug=console.warn=console.trace=console.dir=console.dirxml=console.group=console.groupEnd=console.time=console.timeEnd=console.assert=console.profile=function(){}}function S4(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}function guid(){return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4())}function numberFormat(f,c,h,e){f=(f+"").replace(/[^0-9+\-Ee.]/g,"");var b=!isFinite(+f)?0:+f,a=!isFinite(+c)?0:Math.abs(c),j=(typeof e==="undefined")?",":e,d=(typeof h==="undefined")?".":h,i="",g=function(o,m){var l=Math.pow(10,m);return""+Math.round(o*l)/l};i=(a?g(b,a):""+Math.round(b)).split(".");if(i[0].length>3){i[0]=i[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,j)}if((i[1]||"").length<a){i[1]=i[1]||"";i[1]+=new Array(a-i[1].length+1).join("0")}return i.join(d)}function layoutFix(){var a=$(".sidebar").outerHeight();var b=$(".workspace").outerHeight();var c=a-b;if(c>0){$(".workspace").height(a)}else{$(".sidebar").height(b)}}var App={};var User={};
/*! All system models
*/
var InvoiceItemType=Backbone.Model.extend({});var TaxRate=Backbone.Model.extend({});var VatRegistration=Backbone.Model.extend({});var InvoiceItem=Backbone.RelationalModel.extend({getQuantityString:function(){var d=this.get("quantity");var b=this.get("InvoiceItemType").name;if(b=="Hours"){var c=d*60;var a=0;do{c=c-60;a++}while(c>=60);if(c==0){return a}else{c=Math.round(c);c=sprintf("%1$02d",c);return a+":"+c}}return parseFloat(d)%1==0?parseInt(d):d},shouldRenderField:function(d){var b={Comment:["quantity","price","tax","total"],VAT:["quantity"]};var c=this.get("InvoiceItemType").name;if(!b.hasOwnProperty(c)){return true}var a=b[c];return _.include(a,d)?false:true}});var Invoice=Backbone.RelationalModel.extend({relations:[{type:Backbone.HasMany,key:"InvoiceItems",relatedModel:"InvoiceItem",collectionType:"InvoiceItemCollection",reverseRelation:{key:"invoice",includeInJSON:"id"}}]});var InvoiceItemCollection=Backbone.Collection.extend({model:InvoiceItem});var TaxRateCollection=Backbone.Collection.extend({model:TaxRate});var InvoiceItemTypeCollection=Backbone.Collection.extend({model:InvoiceItemType});
/*! DraftInvoiceView */
var DraftInvoiceView=Backbone.View.extend({el:"#manage",events:{"click .delete":"onDeleteClick","click #add_invoice_item":"onAddInvoiceItem","click .edit":"onEditItemClick"},initialize:function(){this.addItemView=new NewInvoiceItemView({model:this.model,parentView:this});this.model.on("change",this.render,this);this.model.on("change",this.updateTotals,this)},onEditItemClick:function(b){b.preventDefault();var c=$(b.currentTarget).data("id");var a=new EditInvoiceItemView({parentView:this,model:this.model.get("InvoiceItems").get(c)});a.render()},onAddInvoiceItem:function(a){a.preventDefault();this.addItemView.render()},onDeleteClick:function(b){var c=$(b.currentTarget);var d=c.data("id");var a=this;b.preventDefault();$.ajax({url:c.attr("href"),type:"DELETE",data:{id:d},success:function(e){a.model.set(e.Invoice);a.model.trigger("change")}})},updateTotals:function(){var c=numberFormat(this.model.get("sub_total"),2);var a=numberFormat(this.model.get("tax"),2);var b=numberFormat(this.model.get("total"),2);this.$el.find("#net_total_amount").html(c);this.$el.find("#sales_tax_amount").html(a);this.$el.find("#total_amount").html(b)},render:function(){var a=this;var b="";var c=JST.invoice_footer({Invoice:a.model});console.log("rendering");this.model.get("InvoiceItems").each(function(d){b+=JST.invoice_item({InvoiceItem:d,Invoice:a.model})});this.$el.find("#invoice_items").html(b);this.$el.find("tfoot").html(c)}});var EditInvoiceItemView=Backbone.View.extend({events:{"click button#save":"onSave","click a.cancel":"onCancel","change select#invoice_item_type":"onTypeChange"},initialize:function(){this.template=JST.edit_invoice_item;this.parentView=this.options.parentView},onSave:function(b){var a=this;b.preventDefault();$.ajax(this.$el.find("form").attr("action"),{data:this.$el.find("form").serialize(),type:"POST",success:function(c){a.parentView.model.set(c.Invoice);a.parentView.model.trigger("change");$.facebox.close()}})},onTypeChange:function(a){var b=$("#invoice_item_type option:selected").text();if(b=="Hours"){this.$el.find("#hours-help").show()}else{this.$el.find("#hours-help").hide()}if(b=="Comment"){this.$el.find("#tax-row").hide();this.$el.find("#price-row").hide();this.$el.find("#quantity").attr("disabled",true)}else{this.$el.find("#tax-row").show();this.$el.find("#price-row").show();this.$el.find("#quantity").attr("disabled",false)}},onSaveAndContinue:function(a){},onCancel:function(a){a.preventDefault();$.facebox.close()},render:function(){this.setElement(this.template({InvoiceItem:this.model}));$.facebox(this.$el);this.onTypeChange();return this}});var InvoiceFormView=Backbone.View.extend({format:"DD/MM/YYYY",events:{"change #invoice_payment_term_id":"onPaymentTermsChange"},initialize:function(){this.dueDate=this.$el.find("#invoice_due_date");this.dateIssued=this.$el.find("#invoice_date_issued");this.parentLi=this.dueDate.parent("li:first");var b=new Kalendae.Input("invoice_due_date",{months:2,format:this.format});var a=new Kalendae.Input("invoice_date_issued",{months:2,format:this.format})},onPaymentTermsChange:function(b){var a=$(b.currentTarget);var e=parseInt(a.val());if(e!=-1){var d=this.dateIssued.val();var c=Kalendae.moment(d,this.format).add("days",e);this.dueDate.val(c.format(this.format))}},});var NewInvoiceItemView=Backbone.View.extend({events:{"click button#save":"onSave","click a.cancel":"onCancel","change select#invoice_item_type":"onTypeChange"},initialize:function(){this.template=JST.new_invoice_item;this.parentView=this.options.parentView},onSave:function(b){var a=this;b.preventDefault();$.ajax(this.$el.find("form").attr("action"),{data:this.$el.find("form").serialize(),type:"POST",success:function(c){a.parentView.model.get("InvoiceItems").push(c.InvoiceItem);a.parentView.model.set({total:c.Invoice.total,tax:c.Invoice.tax,sub_total:c.Invoice.sub_total});if(c.InvoiceItem.total==0){a.parentView.model.trigger("change")}$.facebox.close()}})},onTypeChange:function(a){var b=$("#invoice_item_type option:selected").text();if(b=="Hours"){this.$el.find("#hours-help").show()}else{this.$el.find("#hours-help").hide()}if(b=="Comment"){this.$el.find("#tax-row").hide();this.$el.find("#price-row").hide();this.$el.find("#quantity").attr("disabled",true)}else{this.$el.find("#tax-row").show();this.$el.find("#price-row").show();this.$el.find("#quantity").attr("disabled",false)}},onSaveAndContinue:function(a){},onCancel:function(a){a.preventDefault();$.facebox.close()},render:function(){this.setElement(this.template({Invoice:this.model}));$.facebox(this.$el);return this}});