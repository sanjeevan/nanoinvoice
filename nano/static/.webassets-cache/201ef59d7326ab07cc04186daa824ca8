var InvoiceItemType=Backbone.Model.extend({});var TaxRate=Backbone.Model.extend({});var VatRegistration=Backbone.Model.extend({});var InvoiceItem=Backbone.RelationalModel.extend({getQuantityString:function(){var q=this.get("quantity");var type=this.get("InvoiceItemType").name;if(type=="Hours"){var mins=q*60;var hours=0;do{mins=mins-60;hours++;}while(mins>=60);if(mins==0){return hours;}else{mins=Math.round(mins);mins=sprintf("%1$02d",mins);return hours+":"+mins;}}
return parseFloat(q)%1==0?parseInt(q):q;},shouldRenderField:function(field){var noRenderFields={"Comment":["quantity","price","tax","total"],"VAT":["quantity"]};var type=this.get("InvoiceItemType").name;if(!noRenderFields.hasOwnProperty(type)){return true;}
var fields=noRenderFields[type];return _.include(fields,field)?false:true;}});var Invoice=Backbone.RelationalModel.extend({relations:[{type:Backbone.HasMany,key:'InvoiceItems',relatedModel:'InvoiceItem',collectionType:'InvoiceItemCollection',reverseRelation:{key:'invoice',includeInJSON:'id'}}]});var InvoiceItemCollection=Backbone.Collection.extend({model:InvoiceItem});var TaxRateCollection=Backbone.Collection.extend({model:TaxRate});var InvoiceItemTypeCollection=Backbone.Collection.extend({model:InvoiceItemType});var DraftInvoiceView=Backbone.View.extend({el:"#manage",events:{"click .delete":"onDeleteClick","click #add_invoice_item":"onAddInvoiceItem","click .edit":"onEditItemClick"},initialize:function(){this.addItemView=new NewInvoiceItemView({model:this.model,parentView:this});this.model.bind("change",this.render,this);this.model.bind("change",this.updateTotals,this);},onEditItemClick:function(evt){evt.preventDefault();var id=$(evt.currentTarget).data("id");console.log(id);var view=new EditInvoiceItemView({parentView:this,model:this.model.get("InvoiceItems").get(id)});view.render();},onAddInvoiceItem:function(evt){evt.preventDefault();this.addItemView.render();},onDeleteClick:function(evt){var el=$(evt.currentTarget);var id=el.data("id");var view=this;evt.preventDefault();$.ajax({url:el.attr("href"),type:"DELETE",data:{"id":id},success:function(json){view.model.set(json.Invoice);}});},updateTotals:function(){var subTotal=numberFormat(this.model.get("sub_total"),2);var salesTax=numberFormat(this.model.get("tax"),2);var total=numberFormat(this.model.get("total"),2);this.$el.find("#net_total_amount").html(subTotal)
this.$el.find("#sales_tax_amount").html(salesTax);this.$el.find("#total_amount").html(total);},render:function(){var view=this;var itemsHtml="";this.model.get("InvoiceItems").each(function(item){itemsHtml+=_.template(AppTemplates["invoice_item.html"],{InvoiceItem:item,Invoice:view.model});});this.$el.find("#invoice_items").html(itemsHtml);}});var EditInvoiceItemView=Backbone.View.extend({events:{"click button#save":"onSave","click a.cancel":"onCancel","change select#invoice_item_type":"onTypeChange"},initialize:function(){this.template=AppTemplates["edit_invoice_item.html"];this.parentView=this.options.parentView;},onSave:function(evt){var view=this;evt.preventDefault();$.ajax(this.$el.find("form").attr("action"),{data:this.$el.find("form").serialize(),type:"POST",success:function(resp){view.parentView.model.set(resp.Invoice);$.facebox.close();}});}, onTypeChange:function(evt){var name=$("#invoice_item_type option:selected").text();if(name=="Hours"){this.$el.find("#hours-help").show();}else{this.$el.find("#hours-help").hide();}
if(name=="Comment"){this.$el.find("#tax-row").hide();this.$el.find("#price-row").hide();this.$el.find("#quantity").attr("disabled",true);}else{this.$el.find("#tax-row").show();this.$el.find("#price-row").show();this.$el.find("#quantity").attr("disabled",false);}},onSaveAndContinue:function(evt){},onCancel:function(evt){evt.preventDefault();$.facebox.close();},render:function(){this.setElement(_.template(this.template,{InvoiceItem:this.model}));$.facebox(this.$el);this.onTypeChange();return this;}});var InvoiceFormView=Backbone.View.extend({format:"DD/MM/YYYY",events:{"change #invoice_payment_term_id":"onPaymentTermsChange"},initialize:function(){this.dueDate=this.$el.find("#invoice_due_date");this.dateIssued=this.$el.find("#invoice_date_issued");this.parentLi=this.dueDate.parent("li:first");var k4=new Kalendae.Input("invoice_due_date",{months:2,format:this.format});var k5=new Kalendae.Input("invoice_date_issued",{months:2,format:this.format});},onPaymentTermsChange:function(evt){var select=$(evt.currentTarget);var days=parseInt(select.val());if(days!=-1){var dateIssued=this.dateIssued.val();var k=Kalendae.moment(dateIssued,this.format).add('days',days);this.dueDate.val(k.format(this.format));}},});var NewInvoiceItemView=Backbone.View.extend({events:{"click button#save":"onSave","click a.cancel":"onCancel","change select#invoice_item_type":"onTypeChange"},initialize:function(){this.template=AppTemplates["new_invoice_item.html"];this.parentView=this.options.parentView;},onSave:function(evt){var view=this;evt.preventDefault();$.ajax(this.$el.find("form").attr("action"),{data:this.$el.find("form").serialize(),type:"POST",success:function(resp){view.parentView.model.get("InvoiceItems").push(resp.InvoiceItem);view.parentView.model.set({"total":resp.Invoice.total,"tax":resp.Invoice.tax,"sub_total":resp.Invoice.sub_total}); view.parentView.model.trigger("change");$.facebox.close();}});}, onTypeChange:function(evt){var name=$("#invoice_item_type option:selected").text();if(name=="Hours"){this.$el.find("#hours-help").show();}else{this.$el.find("#hours-help").hide();}
if(name=="Comment"){this.$el.find("#tax-row").hide();this.$el.find("#price-row").hide();this.$el.find("#quantity").attr("disabled",true);}else{this.$el.find("#tax-row").show();this.$el.find("#price-row").show();this.$el.find("#quantity").attr("disabled",false);}},onSaveAndContinue:function(evt){},onCancel:function(evt){evt.preventDefault();$.facebox.close();},render:function(){this.setElement(_.template(this.template,{Invoice:this.model}));$.facebox(this.$el);return this;}});